{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import '@k2oss/k2-broker-core';\r\n\r\nmetadata = {\r\n    systemName: \"csvreader\",\r\n    displayName: \"CSV Reader Broker\",\r\n    description: \"A broker that reads a CSV file and returns each line as a list.\"\r\n};\r\n\r\nondescribe = async function({configuration}): Promise<void> {\r\n    postSchema({\r\n        objects: {\r\n            \"lines\": {\r\n                displayName: \"Lines\",\r\n                description: \"Describes all lines in a CSV file\",\r\n                properties: {\r\n                    \"fileContent\": {\r\n                        displayName: \"File Content\",\r\n                        type: \"string\"\r\n                    },\r\n                    \"line\": {\r\n                        displayName: \"Line\",\r\n                        type: \"string\"\r\n                    }\r\n                },\r\n                methods: {\r\n                    \"getLines\": {\r\n                        displayName: \"Get Lines\",\r\n                        type: \"read\",\r\n                        inputs: [ \"fileContent\" ],\r\n                        outputs: [ \"line\" ]\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\nonexecute = async function({objectName, methodName, parameters, properties, configuration, schema}): Promise<void> {\r\n    switch (objectName)\r\n    {\r\n        case \"lines\": await onexecuteSplit(methodName, properties); break;\r\n        default: throw new Error(\"The object \" + objectName + \" is not supported.\");\r\n    }\r\n}\r\n\r\nasync function onexecuteSplit(methodName: string, properties: SingleRecord): Promise<void> {\r\n    switch (methodName)\r\n    {\r\n        case \"getLines\": await onexecuteLinesSplit(properties); break;\r\n        default: throw new Error(\"The method \" + methodName + \" is not supported.\");\r\n    }\r\n}\r\n\r\nfunction onexecuteLinesSplit(properties: SingleRecord): Promise<void> {\r\n    return new Promise<void>((resolve, reject) =>\r\n    {\r\n            try {\r\n                const str = Base64.decode(getBase64FromContent(properties[\"fileContent\"].toString()));\r\n                                \r\n                postResult({\r\n                    \"line\": str\r\n                });\r\n                resolve();\r\n            } catch (e) {\r\n                reject(e);\r\n            }        \r\n    });\r\n}\r\n\r\nfunction getBase64FromContent(content: string)\r\n{\r\n    var base64 = \"\";\r\n\r\n    var split1 = content.split(\"<content>\")[1];\r\n    base64 = split1.split(\"</content>\")[0];\r\n\r\n    return base64;\r\n}\r\n\r\nvar Base64 = {\r\n\r\n    // private property\r\n    _keyStr : \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\",\r\n    \r\n    // public method for encoding\r\n    encode : function (input) {\r\n        var output = \"\";\r\n        var chr1, chr2, chr3, enc1, enc2, enc3, enc4;\r\n        var i = 0;\r\n    \r\n        input = Base64._utf8_encode(input);\r\n    \r\n        while (i < input.length) {\r\n    \r\n            chr1 = input.charCodeAt(i++);\r\n            chr2 = input.charCodeAt(i++);\r\n            chr3 = input.charCodeAt(i++);\r\n    \r\n            enc1 = chr1 >> 2;\r\n            enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);\r\n            enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);\r\n            enc4 = chr3 & 63;\r\n    \r\n            if (isNaN(chr2)) {\r\n                enc3 = enc4 = 64;\r\n            } else if (isNaN(chr3)) {\r\n                enc4 = 64;\r\n            }\r\n    \r\n            output = output +\r\n            this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +\r\n            this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);\r\n    \r\n        }\r\n    \r\n        return output;\r\n    },\r\n    \r\n    // public method for decoding\r\n    decode : function (input) {\r\n        var output = \"\";\r\n        var chr1, chr2, chr3;\r\n        var enc1, enc2, enc3, enc4;\r\n        var i = 0;\r\n    \r\n        input = input.replace(/[^A-Za-z0-9\\+\\/\\=]/g, \"\");\r\n    \r\n        while (i < input.length) {\r\n    \r\n            enc1 = this._keyStr.indexOf(input.charAt(i++));\r\n            enc2 = this._keyStr.indexOf(input.charAt(i++));\r\n            enc3 = this._keyStr.indexOf(input.charAt(i++));\r\n            enc4 = this._keyStr.indexOf(input.charAt(i++));\r\n    \r\n            chr1 = (enc1 << 2) | (enc2 >> 4);\r\n            chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);\r\n            chr3 = ((enc3 & 3) << 6) | enc4;\r\n    \r\n            output = output + String.fromCharCode(chr1);\r\n    \r\n            if (enc3 != 64) {\r\n                output = output + String.fromCharCode(chr2);\r\n            }\r\n            if (enc4 != 64) {\r\n                output = output + String.fromCharCode(chr3);\r\n            }\r\n    \r\n        }\r\n    \r\n        output = Base64._utf8_decode(output);\r\n    \r\n        return output;\r\n    \r\n    },\r\n    \r\n    // private method for UTF-8 encoding\r\n    _utf8_encode : function (string) {\r\n        string = string.replace(/\\r\\n/g,\"\\n\");\r\n        var utftext = \"\";\r\n    \r\n        for (var n = 0; n < string.length; n++) {\r\n    \r\n            var c = string.charCodeAt(n);\r\n    \r\n            if (c < 128) {\r\n                utftext += String.fromCharCode(c);\r\n            }\r\n            else if((c > 127) && (c < 2048)) {\r\n                utftext += String.fromCharCode((c >> 6) | 192);\r\n                utftext += String.fromCharCode((c & 63) | 128);\r\n            }\r\n            else {\r\n                utftext += String.fromCharCode((c >> 12) | 224);\r\n                utftext += String.fromCharCode(((c >> 6) & 63) | 128);\r\n                utftext += String.fromCharCode((c & 63) | 128);\r\n            }\r\n    \r\n        }\r\n    \r\n        return utftext;\r\n    },\r\n    \r\n    // private method for UTF-8 decoding\r\n    _utf8_decode : function (utftext) {\r\n        var string = \"\";\r\n        var i = 0;\r\n        var c = 0, c1 = 0, c2 = 0, c3 = 0;\r\n    \r\n        while ( i < utftext.length ) {\r\n    \r\n            c = utftext.charCodeAt(i);\r\n    \r\n            if (c < 128) {\r\n                string += String.fromCharCode(c);\r\n                i++;\r\n            }\r\n            else if((c > 191) && (c < 224)) {\r\n                c2 = utftext.charCodeAt(i+1);\r\n                string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));\r\n                i += 2;\r\n            }\r\n            else {\r\n                c2 = utftext.charCodeAt(i+1);\r\n                c3 = utftext.charCodeAt(i+2);\r\n                string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));\r\n                i += 3;\r\n            }\r\n    \r\n        }\r\n    \r\n        return string;\r\n    }\r\n    \r\n    }"],"names":["metadata","systemName","displayName","description","ondescribe","async","configuration","postSchema","objects","properties","type","methods","inputs","outputs","onexecute","objectName","methodName","parameters","schema","Promise","resolve","reject","str","Base64","decode","content","toString","split","postResult","e","onexecuteLinesSplit","Error","onexecuteSplit","_keyStr","encode","input","chr1","chr2","chr3","enc1","enc2","enc3","enc4","output","i","_utf8_encode","length","charCodeAt","isNaN","this","charAt","replace","indexOf","String","fromCharCode","_utf8_decode","string","utftext","n","c","c2","c3"],"mappings":"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"}